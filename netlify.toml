# Build Flutter web i publikacja na Netlify (deploy z Gita).
[build.environment]
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"
  # Żeby build nie failował na „Exposed secrets” (zmienne SUPABASE_* są w Netlify, nie w repo)
  SECRETS_SCAN_ENABLED = "false"
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"

[[plugins]]
  package = "netlify-plugin-flutter"

[plugins.inputs]
  channel = "stable"

[build]
  # prepare: env.production (z netlify_env.sh), Flutter build, polityka/regulamin/env do build/web
  command = "bash scripts/netlify_env.sh && bash scripts/prepare_latwaforma_pl.sh"
  publish = "build/web"
  functions = "netlify/functions"

# Endpoint dla Garmin (CONSUMER_PERMISSIONS push, USER_DEREG ping). Wszystkie warianty ścieżki → ta sama funkcja (unikamy 404).
[[redirects]]
  from = "/api/garmin"
  to = "/.netlify/functions/garmin"
  status = 200
  force = true
[[redirects]]
  from = "/api/garmin/"
  to = "/.netlify/functions/garmin"
  status = 200
  force = true
[[redirects]]
  from = "/api/garmin/*"
  to = "/.netlify/functions/garmin"
  status = 200
  force = true
[[redirects]]
  from = "/api/garmin-disconnect"
  to = "/.netlify/functions/garmin-disconnect"
  status = 200
  force = true
